<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Culture Archive</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style id="main-styles">
        :root{--ca-blue-50:#f0f6ff; --ca-blue-100:#e4f0ff; --ca-blue-400:#72a7ff; --ca-blue-500:#e8f0ff; --ca-blue-600:#3a75e6; --ca-ink:#0f172a; --ca-muted:#6b7280; --card-r:16px;}
        body{background:linear-gradient(180deg,var(--ca-blue-50),#fff 60%);}
        .navbar{box-shadow:0 2px 8px rgba(0,0,0,.04);}
        .btn-ca{background:var(--ca-blue-600); border-color:var(--ca-blue-600); color:#fff;}
        .btn-ca:hover{background:var(--ca-blue-500); border-color:var(--ca-blue-500);}
        .hero-card{border-radius:var(--card-r); background:#fff; box-shadow:0 12px 40px rgba(0,0,0,.06); padding:2.25rem 1.5rem; margin-top:2rem; text-align:center;}
        .hero-title{font-weight:800; letter-spacing:-.3px; color:var(--ca-ink);}
        .hero-sub{color:#6b7280;}
        .hero-actions{max-width:720px; margin:0 auto;}
        .search-wrap{display:flex; gap:.5rem; align-items:center; justify-content:center;}
        .search-wrap .form-control{height:44px;}
        .btn-search{height:44px; min-width:84px; white-space:nowrap;}
        .btn-icon{display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .8rem; border-radius:999px;}
        .btn-icon svg{width:18px; height:18px;}
        .poster-wrap{width:120px; height:180px; overflow:hidden; border-radius:var(--card-r); background:#f8f9fa; flex:0 0 auto; display:flex; align-items:center; justify-content:center;}
        .poster-img{width:100%; height:100%; object-fit:cover;}
        .event-card{border:0; border-radius:var(--card-r); box-shadow:0 8px 24px rgba(0,0,0,.05); transition:transform .2s; min-height:200px;}
        .event-card:hover{transform:translateY(-4px);}

        /* 커뮤니티 카드 스타일 */
        .review-card{border:0;border-radius:var(--card-r);box-shadow:0 8px 24px rgba(0,0,0,.05)}
        .review-thumb{width:84px;height:120px;border-radius:12px;overflow:hidden;flex:0 0 auto;background:#f8f9fa}
        .review-thumb img{width:100%;height:100%;object-fit:cover}
        .rating-badge{font-weight:700;color:#f59e0b}
        .review-card {
        min-height: 180px;
        }
        .review-card .mt-2.small {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        font-size: .9rem;
        line-height: 1.4;
        }
        .review-card .fw-semibold {
        white-space: normal;
        }

    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div class="hero-card">
        <h1 class="hero-title mb-2">나의 문화생활 아카이브</h1>
        <p class="hero-sub mb-4">검색하거나 사진으로 바로 기록을 시작하세요.</p>
        <p th:if="${isPersonalized}" class="text-secondary">
            <small>키워드: <span th:text="${recommendedKeywords}"></span></small>
        </p>

        <div class="hero-actions">
            <form class="search-wrap mb-2" th:action="@{/events/search}" method="get">
                <input type="text" class="form-control" name="title" placeholder="제목으로 검색"/>
                <button class="btn btn-ca btn-search" type="submit">검색</button>
            </form>

            <div class="d-flex justify-content-center">
                <!-- 로그인 사용자는 업로드로 이동 -->
                <a class="btn btn-outline-secondary btn-icon"
                   sec:authorize="isAuthenticated()" th:href="@{/ocr/upload}">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M4 8h3l2-3h6l2 3h3v12H4V8z" stroke="currentColor" stroke-width="1.6"
                              stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="14" r="4.25" stroke="currentColor" stroke-width="1.6"/>
                    </svg>
                    <span>사진으로 기록하기</span>
                </a>
                <!-- 비로그인은 로그인 후 업로드로 리다이렉트 -->
                <a class="btn btn-outline-secondary btn-icon"
                   sec:authorize="isAnonymous()"
                   th:href="@{/member/login(redirect='/ocr/upload')}">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M4 8h3l2-3h6l2 3h3v12H4V8z" stroke="currentColor" stroke-width="1.6"
                              stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="14" r="4.25" stroke="currentColor" stroke-width="1.6"/>
                    </svg>
                    <span>사진으로 기록하기</span>
                </a>
            </div>
        </div>
    </div>

    <section class="py-5">
        <div class="row g-4">
            <!-- 좌측: 이벤트 박스 -->
            <div class="col-lg-8">
                <div id="eventsBox" th:fragment="eventsBox">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-semibold">다가오는 일정
                            <span class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status"></span>
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <!-- htmx 호출 URL은 Thymeleaf로 계산 => th:hx-get 사용 -->
                            <button type="button" class="btn btn-outline-secondary"
                                    th:hx-get="@{/events/box(size=${size},page=${page-1},mode=${isPersonalized} ? 'personal' : 'default')}"
                                    hx-target="#eventsBox" hx-swap="outerHTML" hx-select="#eventsBox"
                                    hx-push-url="false"
                                    th:disabled="${isFirst}">▲
                            </button>
                            <button type="button" class="btn btn-outline-secondary"
                                    th:hx-get="@{/events/box(size=${size},page=${page+1},mode=${isPersonalized} ? 'personal' : 'default')}"
                                    hx-target="#eventsBox" hx-swap="outerHTML" hx-select="#eventsBox"
                                    hx-push-url="false"
                                    th:disabled="${isLast}">▼
                            </button>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6" th:each="e : ${events}">
                            <div class="card event-card h-100 d-flex flex-row p-3">
                                <div class="poster-wrap">
                                    <img class="poster-img" th:src="${e.imageUrl}" th:alt="${e.title}"/>
                                </div>
                                <div class="d-flex flex-column justify-content-between flex-grow-1 ps-3">
                                    <div>
                                        <h6 class="fw-semibold" th:text="${e.title}"></h6>
                                        <div class="text-secondary small"
                                             th:text="${#strings.isEmpty(e.displayPeriod) ? '일정은 상세보기에서 확인하세요.' : e.displayPeriod}"></div>
                                        <div class="text-secondary small" th:if="${!#strings.isEmpty(e.deadlineLabel)}"
                                             th:text="${e.deadlineLabel}"></div>
                                        <div class="text-secondary small" th:text="${e.site}"></div>
                                    </div>
                                    <a class="btn btn-sm btn-ca mt-2" th:href="${e.url}" target="_blank" rel="noopener">상세보기</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-12" th:if="${events == null or #lists.isEmpty(events)}">
                            <div class="alert alert-light border">표시할 일정이 없습니다.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 우측: 커뮤니티 카드 영역 -->
            <div class="col-lg-4">
                <!-- fragment + id 쌍으로 만들면 htmx가 이 블록만 갈아끼움 -->
                <div id="communityBox" th:fragment="communityBox" class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5 class="fw-semibold mb-0">커뮤니티 관람후기</h5>
                            <div class="btn-group btn-group-sm">
                                <!-- 이전 페이지: cPage==0이면 비활성 -->
                                <button class="btn btn-outline-secondary"
                                        th:hx-get="@{/community/box(page=${cPage-1},size=2)}"
                                        hx-target="#communityBox" hx-swap="outerHTML" hx-select="#communityBox"
                                        th:disabled="${cPage==0}">▲
                                </button>
                                <!-- 다음 페이지: 마지막 페이지면 비활성 -->
                                <button class="btn btn-outline-secondary"
                                        th:hx-get="@{/community/box(page=${cPage+1},size=2)}"
                                        hx-target="#communityBox" hx-swap="outerHTML" hx-select="#communityBox"
                                        th:disabled="${cPage>=cTotal-1}">▼
                                </button>
                            </div>
                        </div>

                        <!-- 커뮤니티 카드 2개씩 -->
                        <div class="vstack gap-3">
                            <a th:each="r : ${reviews}" th:href="@{/reviews/{id}(id=${r.id})}"
                               class="card review-card p-3 d-flex flex-row align-items-start text-decoration-none text-reset">
                                <div class="review-thumb me-3">
                                    <img th:src="${r.eventPosterUrl}"
                                         onerror="this.onerror=null;this.src='https://via.placeholder.com/84x120?text=Poster'">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <div class="small text-secondary"
                                             th:text="${#temporals.format(r.createdAt,'yyyy.MM.dd')}"></div>
                                        <div class="rating-badge" th:if="${r.rating != null}">★ <span
                                                th:text="${r.rating}"></span></div>
                                    </div>
                                    <div class="fw-semibold mt-1 text-truncate" th:text="${r.eventTitle}"></div>
                                    <div class="text-secondary small text-truncate" th:text="${r.eventPlace}"></div>
                                    <!-- 말줄임 2줄 -->
                                    <div class="mt-2 small"
                                         style="-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;"
                                         th:text="${r.comment}"></div>
                                    <div class="mt-2 d-flex align-items-center gap-2">
                    <span class="avatar"
                          style="width:24px;height:24px;border-radius:50%;background:var(--ca-blue-100);display:inline-flex;align-items:center;justify-content:center;"
                          th:text="${#strings.substring(r.author.username,0,1)}"></span>
                                        <span class="small" th:text="${r.author.username}"></span>
                                    </div>
                                </div>
                            </a>

                            <div class="alert alert-light border" th:if="${reviews == null or #lists.isEmpty(reviews)}">
                                표시할 후기가 없습니다.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /우측 -->
        </div>
    </section>
</div>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
